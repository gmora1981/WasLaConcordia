@page "/admin/advanced-permissions"
@using Identity.Api.Interfaces
@using LaConcordia.Model
@using LaConcordia.Repository
@using Microsoft.AspNetCore.Components.Authorization
@inject IUsersRepository usersRepository
@inject INavigationRepository navigationRepository
@inject IPermissionService permissionService
@inject HttpClient httpClient
@inject IJSRuntime JSRuntime
@inject IDisplayMessage displayMessage
@attribute [Authorize(Roles = "Admin")]

<!-- Importar CSS -->
<link href="css/AdminCommon.css" rel="stylesheet" />
<link href="css/AdvancedPermissions.css" rel="stylesheet" />

<div class="page-container">
    <div class="content-card">
        <div class="header-section">
            <h1 class="page-title">
                <i class="fas fa-shield-alt"></i> Gestión Avanzada de Permisos
            </h1>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-modern btn-primary-modern" @onclick="ShowPermissionMatrix">
                    <i class="fas fa-table"></i> Matriz de Permisos
                </button>
                <button class="btn-modern btn-secondary-modern" @onclick="ShowBulkAssignment">
                    <i class="fas fa-users-cog"></i> Asignación Masiva
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert-modern alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                @errorMessage
                <button type="button" style="background: transparent; border: none; color: inherit; margin-left: auto; cursor: pointer;" @onclick="() => errorMessage = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert-modern alert-success">
                <i class="fas fa-check-circle"></i>
                @successMessage
                <button type="button" style="background: transparent; border: none; color: inherit; margin-left: auto; cursor: pointer;" @onclick="() => successMessage = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }

        <!-- Pestañas -->
        <div class="tab-container">
            <div class="tab-headers">
                <button class="tab-header @(activeTab == "users" ? "active" : "")" @onclick="@(() => SetActiveTab("users"))">
                    <i class="fas fa-users"></i> Permisos por Usuario (@users.Count)
                </button>
                <button class="tab-header @(activeTab == "roles" ? "active" : "")" @onclick="@(() => SetActiveTab("roles"))">
                    <i class="fas fa-user-tag"></i> Permisos por Rol (@roles.Count)
                </button>
                <button class="tab-header @(activeTab == "navigation" ? "active" : "")" @onclick="@(() => SetActiveTab("navigation"))">
                    <i class="fas fa-sitemap"></i> Items de Navegación (@navigationItems.Count)
                </button>
                <button class="tab-header @(activeTab == "tools" ? "active" : "")" @onclick="@(() => SetActiveTab("tools"))">
                    <i class="fas fa-tools"></i> Herramientas
                </button>
            </div>

            <!-- Contenido de Pestañas -->
            <div class="tab-content" style="min-height: 400px; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                @* PESTAÑA USUARIOS *@
                @if (activeTab == "users")
                {
                    <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="flex-grow-1">
        <p class="text-muted mb-0">Total: @TotalUsuarios | Página: @PaginaActual</p>
    </div>
    <div class="d-flex justify-content-center flex-grow-1">
        <Pagination TotalItems="@TotalUsuarios"
                    PageSize="@PageSize"
                    CurrentPage="@PaginaActual"
                    />
    </div>
    <div class="flex-grow-1 text-end"></div>
</div>
                    <div class="tab-pane" style="background: white; padding: 1.5rem; border-radius: 8px; min-height: 300px;">
                        <h3>Gestión de Permisos por Usuario</h3>

                        <div class="filter-section">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Buscar usuario..." @bind="userSearchTerm" @bind:event="oninput" @onkeyup="FilterUsers" />
                            </div>
                            <button class="btn-modern btn-primary-modern" @onclick="LoadUserPermissions">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>

                        @if (isLoadingUsers)
                        {
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <p>Cargando usuarios...</p>
                            </div>
                        }
                        else
                        {
                            @if (filteredUsers != null && filteredUsers.Any())
                            {
                                <div class="user-permissions-grid">
                                    @foreach (var user in filteredUsers.Take(20))
                                    {
                                        <div class="user-permission-card">
                                            <div class="user-info">
                                                <div class="user-avatar">
                                                    @((!string.IsNullOrEmpty(user.FirstName) ? user.FirstName.Substring(0, 1).ToUpper() : "?"))
                                                </div>
                                                <div class="user-details">
                                                    <h4>@user.FirstName @user.LastName</h4>
                                                    <p>@user.Email</p>
                                                    @if (userRoles.ContainsKey(user.UserId))
                                                    {
                                                        <div class="user-roles">
                                                            @foreach (var role in userRoles[user.UserId])
                                                            {
                                                                <span class="role-badge">@role</span>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                            <div class="permission-actions">
                                                <button class="btn-icon btn-edit" @onclick="() => ManageUserPermissions(user)" title="Gestionar Permisos">
                                                    <i class="fas fa-key"></i>
                                                </button>
                                                <button class="btn-icon btn-roles" @onclick="() => ViewUserPermissions(user)" title="Ver Permisos">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn-icon btn-secondary" @onclick="() => OpenCopyModal(user)" title="Copiar Permisos">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <i class="fas fa-users-slash"></i>
                                    <p>No se encontraron usuarios</p>
                                </div>
                            }
                        }
                    </div>
                }
                @* PESTAÑA ROLES *@
                else if (activeTab == "roles")
                {
                    <div class="tab-pane" style="background: white; padding: 1.5rem; border-radius: 8px; min-height: 300px;">
                        <h3>Gestión de Permisos por Rol</h3>

                        @if (isLoadingRoles)
                        {
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <p>Cargando roles...</p>
                            </div>
                        }
                        else
                        {
                            @if (roles != null && roles.Any())
                            {
                                <div class="roles-grid">
                                    @foreach (var role in roles)
                                    {
                                        <div class="role-card">
                                            <div class="role-header">
                                                <h4>
                                                    <i class="fas @(role.RoleName == "Admin" ? "fa-crown" : "fa-user")"></i>
                                                    @role.RoleName
                                                </h4>
                                                <div class="role-actions">
                                                    <button class="btn-icon btn-edit" @onclick="() => ManageRolePermissions(role)" title="Gestionar Permisos">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <button class="btn-icon btn-roles" @onclick="() => ViewRolePermissions(role)" title="Ver Permisos">
                                                        <i class="fas fa-list"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="role-stats">
                                                <p>Usuarios en este rol: <strong>@GetUsersInRoleCount(role.RoleName)</strong></p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <i class="fas fa-user-tag"></i>
                                    <p>No se encontraron roles</p>
                                </div>
                            }
                        }
                    </div>
                }
                @* PESTAÑA NAVEGACIÓN *@
                else if (activeTab == "navigation")
                {
                    <div class="tab-pane" style="background: white; padding: 1.5rem; border-radius: 8px; min-height: 300px;">
                        <h3>Items de Navegación</h3>
                        <p style="margin-bottom: 1.5rem; color: #7f8c8d;">
                            Gestiona los elementos del menú de navegación y sus permisos asociados.
                        </p>

                        @if (isLoadingNavigation)
                        {
                            <div class="loading-container">
                                <div class="loading-spinner"></div>
                                <p>Cargando navegación...</p>
                            </div>
                        }
                        else
                        {
                            @if (navigationItems != null && navigationItems.Any())
                            {
                                <div class="navigation-tree">
                                    @foreach (var item in navigationItems.Where(i => i.ParentId == null).OrderBy(i => i.Order))
                                    {
                                        <div class="nav-tree-item">
                                            <div class="nav-item-header">
                                                @if (!string.IsNullOrEmpty(item.Icon))
                                                {
                                                    <i class="@item.Icon"></i>
                                                }
                                                <span class="nav-title">@item.Title</span>
                                                @if (!string.IsNullOrEmpty(item.RequiredRole))
                                                {
                                                    <span class="permission-badge">@item.RequiredRole</span>
                                                }
                                                <button class="btn-icon btn-edit" @onclick="() => ManageNavigationPermissions(item)" title="Gestionar Permisos">
                                                    <i class="fas fa-key"></i>
                                                </button>
                                            </div>

                                            @if (item.Children != null && item.Children.Any())
                                            {
                                                <div class="nav-children">
                                                    @foreach (var child in item.Children.OrderBy(c => c.Order))
                                                    {
                                                        <div class="nav-child-item">
                                                            @if (!string.IsNullOrEmpty(child.Icon))
                                                            {
                                                                <i class="@child.Icon"></i>
                                                            }
                                                            <span>@child.Title</span>
                                                            @if (!string.IsNullOrEmpty(child.RequiredRole))
                                                            {
                                                                <span class="permission-badge">@child.RequiredRole</span>
                                                            }
                                                            <button class="btn-icon btn-edit" @onclick="() => ManageNavigationPermissions(child)" title="Gestionar Permisos">
                                                                <i class="fas fa-key"></i>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <i class="fas fa-sitemap"></i>
                                    <p>No hay elementos de navegación configurados</p>
                                    <a href="/admin/navigation" class="btn-modern btn-primary-modern">
                                        <i class="fas fa-plus"></i> Crear Elementos
                                    </a>
                                </div>
                            }
                        }
                    </div>
                }
                @* PESTAÑA HERRAMIENTAS *@
                else if (activeTab == "tools")
                {
                    <div class="tab-pane" style="background: white; padding: 1.5rem; border-radius: 8px; min-height: 300px;">
                        <h3>Herramientas de Gestión</h3>

                        <div class="tools-grid">
                            <div class="tool-card">
                                <div class="tool-icon">
                                    <i class="fas fa-copy"></i>
                                </div>
                                <h4>Copiar Permisos</h4>
                                <p>Copia permisos entre usuarios o roles</p>
                                <button class="btn-modern btn-primary-modern" @onclick="ShowCopyPermissions">
                                    Usar Herramienta
                                </button>
                            </div>

                            <div class="tool-card">
                                <div class="tool-icon">
                                    <i class="fas fa-broom"></i>
                                </div>
                                <h4>Limpiar Permisos</h4>
                                <p>Resetea todos los permisos de un usuario o rol</p>
                                <button class="btn-modern btn-secondary-modern" @onclick="ShowResetPermissions">
                                    Usar Herramienta
                                </button>
                            </div>

                            <div class="tool-card">
                                <div class="tool-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <h4>Reporte de Permisos</h4>
                                <p>Genera reportes detallados de permisos</p>
                                <button class="btn-modern btn-info" @onclick="ShowPermissionsReport">
                                    Generar Reporte
                                </button>
                            </div>

                            <div class="tool-card">
                                <div class="tool-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h4>Auditoría</h4>
                                <p>Revisa el historial de cambios de permisos</p>
                                <button class="btn-modern btn-warning" @onclick="ShowAuditLog">
                                    Ver Auditoría
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal de gestión de permisos de usuario -->
@if (showPermissionModal && selectedUserForPermissions != null)
{
    <UserPermissionModal showModal="showPermissionModal"
                         selectedUser="selectedUserForPermissions"
                         OnModalClosed="OnPermissionModalClosed" />
}

<!-- Modal de gestión de permisos de rol -->
@if (showRolePermissionModal && selectedRoleForPermissions != null)
{
    <RolePermissionModal showModal="showRolePermissionModal"
                         selectedRole="selectedRoleForPermissions"
                         usersInRole="GetUsersInRoleCount(selectedRoleForPermissions.RoleName)"
                         OnModalClosed="OnRolePermissionModalClosed" />
}

<!-- Modal de permisos de navegación -->
@if (showNavigationPermissionModal && selectedNavigationItem != null)
{
    <NavigationPermissionModal showModal="showNavigationPermissionModal"
                               selectedNavigationItem="selectedNavigationItem"
                               OnModalClosed="OnNavigationPermissionModalClosed"
                               OnSettingsUpdated="OnNavigationSettingsUpdated" />
}

<!-- Modal de copia de permisos original (para usuarios individuales) -->
@if (showCopyModal && selectedUserForCopy != null)
{
    <CopyPermissionsModal showModal="showCopyModal"
                          sourceUser="selectedUserForCopy"
                          allUsers="users"
                          OnModalClosed="OnCopyModalClosed"
                          OnSuccess="OnCopySuccess"
                          OnError="OnCopyError" />
}

<!-- Modal de matriz de permisos -->
<PermissionMatrixModal @bind-showModal="showMatrixModal" />

<!-- Modal de asignación masiva global -->
<GlobalBulkAssignmentModal @bind-showModal="showBulkModal" />

<!-- **NUEVOS MODALES DE HERRAMIENTAS** -->
<!-- Modal de herramienta de copia avanzada -->
<CopyPermissionsToolModal showModal="showCopyToolModal"
                          OnModalClosed="OnCopyToolModalClosed"
                          OnSuccess="OnCopySuccess"
                          OnError="OnCopyError" />

<!-- Modal de herramienta de reseteo -->
<ResetPermissionsModal showModal="showResetModal"
                       OnModalClosed="OnResetModalClosed"
                       OnSuccess="OnResetSuccess"
                       OnError="OnResetError" />

<!-- Modal de reportes -->
<PermissionsReportModal showModal="showReportModal"
                        OnModalClosed="OnReportModalClosed" />

<!-- Modal de auditoría -->
<AuditLogModal showModal="showAuditModal"
               OnModalClosed="OnAuditModalClosed" />

<!-- Script JavaScript para descargar archivos -->
<script>
    window.downloadFile = function(filename, content, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    };
</script>

@code {
    private string activeTab = "users";
    private string? errorMessage;
    private string? successMessage;
    private bool isInitialized = false;

    // Loading states
    private bool isLoadingUsers = false;
    private bool isLoadingRoles = false;
    private bool isLoadingNavigation = false;

    // Data collections
    private List<UserDTO> users = new List<UserDTO>();
    private List<UserDTO> filteredUsers = new List<UserDTO>();
    private List<RoleDTO> roles = new List<RoleDTO>();
    private List<NavigationItemDto> navigationItems = new List<NavigationItemDto>();
    private Dictionary<string, List<string>> userRoles = new Dictionary<string, List<string>>();
    private Dictionary<string, int> roleUserCounts = new Dictionary<string, int>();

    // Search and filters
    private string userSearchTerm = "";

    // Modal states - Modales originales
    private bool showPermissionModal = false;
    private bool showMatrixModal = false;
    private bool showBulkModal = false;
    private bool showCopyModal = false;
    private bool showRolePermissionModal = false;
    private bool showNavigationPermissionModal = false;

    // Modal states - Nuevos modales de herramientas
    private bool showCopyToolModal = false;
    private bool showResetModal = false;
    private bool showReportModal = false;
    private bool showAuditModal = false;

    // Selected items for modals
    private UserDTO? selectedUserForPermissions;
    private UserDTO? selectedUserForCopy;
    private RoleDTO? selectedRoleForPermissions;
    private NavigationItemDto? selectedNavigationItem;

    // Paginación
    private int PaginaActual = 1;
    private int PageSize = 8;
    private int TotalUsuarios = 0;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("🔥 OnInitializedAsync - INICIANDO");

        try
        {
            StateHasChanged();
            await LoadAllData();
            isInitialized = true;
            Console.WriteLine("✅ OnInitializedAsync - COMPLETADO");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ OnInitializedAsync - ERROR: {ex.Message}");
            errorMessage = $"Error al inicializar: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task LoadAllData()
    {
        Console.WriteLine("🔄 LoadAllData - INICIANDO");
        await LoadUsers();
        await LoadRoles();
        await LoadNavigationItems();
        Console.WriteLine("✅ LoadAllData - COMPLETADO");
    }

    private async Task LoadUsers()
    {
        Console.WriteLine("👤 LoadUsers - INICIANDO");

        try
        {
            isLoadingUsers = true;
            StateHasChanged();

            var paginationDTO = new PaginationDTO { Page = 1, RecordsPerPage = 20 };
            var response = await usersRepository.GetUsers(paginationDTO);

            if (response?.Response != null)
            {
                users = response.Response.ToList();
                Console.WriteLine($"👤 LoadUsers - Usuarios obtenidos: {users.Count}");
            }
            else
            {
                users = new List<UserDTO>();
                Console.WriteLine("⚠️ LoadUsers - Response nulo o vacío");
            }

            userRoles.Clear();
            foreach (var user in users)
            {
                try
                {
                    var userRolesList = await usersRepository.GetUserRoles(user.UserId);
                    userRoles[user.UserId] = userRolesList ?? new List<string>();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"⚠️ Error cargando roles para usuario {user.UserId}: {ex.Message}");
                    userRoles[user.UserId] = new List<string>();
                }
            }

            FilterUsers();
            Console.WriteLine($"✅ LoadUsers - COMPLETADO. Usuarios filtrados: {filteredUsers.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ LoadUsers - ERROR: {ex.Message}");
            users = new List<UserDTO>();
            filteredUsers = new List<UserDTO>();
        }
        finally
        {
            isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private async Task LoadRoles()
    {
        Console.WriteLine("🏷️ LoadRoles - INICIANDO");

        try
        {
            isLoadingRoles = true;
            StateHasChanged();

            var rolesResponse = await usersRepository.GetRoles();
            roles = rolesResponse?.ToList() ?? new List<RoleDTO>();
            Console.WriteLine($"🏷️ LoadRoles - Roles obtenidos: {roles.Count}");

            roleUserCounts.Clear();
            foreach (var role in roles)
            {
                roleUserCounts[role.RoleName] = users.Count(u =>
                    userRoles.ContainsKey(u.UserId) &&
                    userRoles[u.UserId].Contains(role.RoleName));
            }

            Console.WriteLine("✅ LoadRoles - COMPLETADO");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ LoadRoles - ERROR: {ex.Message}");
            roles = new List<RoleDTO>();
        }
        finally
        {
            isLoadingRoles = false;
            StateHasChanged();
        }
    }

    private async Task LoadNavigationItems()
    {
        Console.WriteLine("🧭 LoadNavigationItems - INICIANDO");

        try
        {
            isLoadingNavigation = true;
            StateHasChanged();

            var items = await navigationRepository.GetAllAsync();
            var itemsList = items?.ToList() ?? new List<NavigationItemDto>();

            Console.WriteLine($"🧭 LoadNavigationItems - Items obtenidos: {itemsList.Count}");

            if (itemsList.Any())
            {
                var lookup = itemsList.ToLookup(i => i.ParentId);
                navigationItems = itemsList.Where(i => i.ParentId == null)
                    .Select(item => new NavigationItemDto
                    {
                        Id = item.Id,
                        ParentId = item.ParentId,
                        Title = item.Title ?? "",
                        Url = item.Url,
                        Icon = item.Icon,
                        Order = item.Order,
                        IsActive = item.IsActive,
                        RequiredRole = item.RequiredRole,
                        Children = lookup[item.Id].Select(child => new NavigationItemDto
                        {
                            Id = child.Id,
                            ParentId = child.ParentId,
                            Title = child.Title ?? "",
                            Url = child.Url,
                            Icon = child.Icon,
                            Order = child.Order,
                            IsActive = child.IsActive,
                            RequiredRole = child.RequiredRole,
                            Children = new List<NavigationItemDto>()
                        }).ToList()
                    }).ToList();
            }
            else
            {
                navigationItems = new List<NavigationItemDto>();
            }

            Console.WriteLine($"✅ LoadNavigationItems - COMPLETADO. Items jerárquicos: {navigationItems.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ LoadNavigationItems - ERROR: {ex.Message}");
            navigationItems = new List<NavigationItemDto>();
        }
        finally
        {
            isLoadingNavigation = false;
            StateHasChanged();
        }
    }

    private void FilterUsers()
    {
        if (string.IsNullOrWhiteSpace(userSearchTerm))
        {
            filteredUsers = new List<UserDTO>(users);
        }
        else
        {
            var searchLower = userSearchTerm.ToLower();
            filteredUsers = users.Where(u =>
                (u.Email?.ToLower().Contains(searchLower) == true) ||
                (u.FirstName?.ToLower().Contains(searchLower) == true) ||
                (u.LastName?.ToLower().Contains(searchLower) == true)
            ).ToList();
        }
        StateHasChanged();
    }

    private void SetActiveTab(string tab)
    {
        Console.WriteLine($"🔄 Cambiando a tab: {tab}");
        activeTab = tab;

        // Cerrar todos los modales al cambiar de pestaña
        CloseAllModals();

        StateHasChanged();
    }

    private void CloseAllModals()
    {
        // Modales originales
        if (showPermissionModal)
        {
            Console.WriteLine("🔒 Cerrando modal de permisos al cambiar de pestaña");
            showPermissionModal = false;
            selectedUserForPermissions = null;
        }

        if (showRolePermissionModal)
        {
            Console.WriteLine("🔒 Cerrando modal de permisos de rol al cambiar de pestaña");
            showRolePermissionModal = false;
            selectedRoleForPermissions = null;
        }

        if (showNavigationPermissionModal)
        {
            Console.WriteLine("🔒 Cerrando modal de permisos de navegación al cambiar de pestaña");
            showNavigationPermissionModal = false;
            selectedNavigationItem = null;
        }

        if (showMatrixModal)
        {
            showMatrixModal = false;
        }

        if (showBulkModal)
        {
            showBulkModal = false;
        }

        if (showCopyModal)
        {
            showCopyModal = false;
            selectedUserForCopy = null;
        }

        // Nuevos modales de herramientas
        if (showCopyToolModal)
        {
            showCopyToolModal = false;
        }

        if (showResetModal)
        {
            showResetModal = false;
        }

        if (showReportModal)
        {
            showReportModal = false;
        }

        if (showAuditModal)
        {
            showAuditModal = false;
        }
    }

    // Modal handlers - Originales
    private void OnCopyModalClosed()
    {
        Console.WriteLine("🔒 Modal de copia cerrado");
        showCopyModal = false;
        selectedUserForCopy = null;
        StateHasChanged();
    }

    private void OnCopySuccess(string message)
    {
        Console.WriteLine($"✅ Copia exitosa: {message}");
        successMessage = message;

        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            successMessage = null;
            InvokeAsync(StateHasChanged);
        });

        StateHasChanged();
    }

    private void OnCopyError(string message)
    {
        Console.WriteLine($"❌ Error en copia: {message}");
        errorMessage = message;

        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            errorMessage = null;
            InvokeAsync(StateHasChanged);
        });

        StateHasChanged();
    }

    private void OnPermissionModalClosed()
    {
        Console.WriteLine("🔒 Modal de permisos cerrado");
        showPermissionModal = false;
        selectedUserForPermissions = null;
        StateHasChanged();
    }

    private void OnRolePermissionModalClosed()
    {
        Console.WriteLine("🔒 Modal de permisos de rol cerrado");
        showRolePermissionModal = false;
        selectedRoleForPermissions = null;
        StateHasChanged();
    }

    private void OnNavigationPermissionModalClosed()
    {
        Console.WriteLine("🔒 Modal de permisos de navegación cerrado");
        showNavigationPermissionModal = false;
        selectedNavigationItem = null;
        StateHasChanged();
    }

    private async Task OnNavigationSettingsUpdated()
    {
        Console.WriteLine("🔄 Configuración de navegación actualizada");
        await LoadNavigationItems();
        successMessage = "Configuración del elemento de navegación actualizada exitosamente";
        StateHasChanged();
    }

    // Modal handlers - Nuevas herramientas
    private void OnCopyToolModalClosed()
    {
        Console.WriteLine("🔒 Modal de herramienta de copia cerrado");
        showCopyToolModal = false;
        StateHasChanged();
    }

    private void OnResetModalClosed()
    {
        Console.WriteLine("🔒 Modal de reseteo cerrado");
        showResetModal = false;
        StateHasChanged();
    }

    private void OnResetSuccess(string message)
    {
        Console.WriteLine($"✅ Reseteo exitoso: {message}");
        successMessage = message;

        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            successMessage = null;
            InvokeAsync(StateHasChanged);
        });

        StateHasChanged();
    }

    private void OnResetError(string message)
    {
        Console.WriteLine($"❌ Error en reseteo: {message}");
        errorMessage = message;

        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            errorMessage = null;
            InvokeAsync(StateHasChanged);
        });

        StateHasChanged();
    }

    private void OnReportModalClosed()
    {
        Console.WriteLine("🔒 Modal de reportes cerrado");
        showReportModal = false;
        StateHasChanged();
    }

    private void OnAuditModalClosed()
    {
        Console.WriteLine("🔒 Modal de auditoría cerrado");
        showAuditModal = false;
        StateHasChanged();
    }

    private async Task LoadUserPermissions()
    {
        await LoadUsers();
        successMessage = "Lista de usuarios actualizada";
        StateHasChanged();
    }

    private int GetUsersInRoleCount(string roleName)
    {
        return roleUserCounts.GetValueOrDefault(roleName, 0);
    }

    // User permissions management
    private async Task ManageUserPermissions(UserDTO user)
    {
        selectedUserForPermissions = user;
        showPermissionModal = true;
        StateHasChanged();
    }

    private async Task ViewUserPermissions(UserDTO user)
    {
        try
        {
            var permissions = await permissionService.GetUserPermissionsAsync(user.UserId);
            var permissionSummary = permissions.Permissions
                .Where(p => p.CanView || p.CanCreate || p.CanEdit || p.CanDelete)
                .Select(p => $"• {p.NavigationItemTitle}: {GetPermissionSummary(p)}")
                .Take(5)
                .ToList();

            var message = permissionSummary.Any()
                ? $"Permisos de {user.FirstName} {user.LastName}:\n\n{string.Join("\n", permissionSummary)}"
                : $"{user.FirstName} {user.LastName} no tiene permisos específicos asignados.";

            await JSRuntime.InvokeVoidAsync("alert", message);
        }
        catch (Exception ex)
        {
            await displayMessage.DisplayErrorMessage($"Error al obtener permisos: {ex.Message}");
        }
    }

    private void OpenCopyModal(UserDTO user)
    {
        Console.WriteLine($"🆕 Abriendo modal de copia para {user.FirstName} {user.LastName}");
        selectedUserForCopy = user;
        showCopyModal = true;
        StateHasChanged();
    }

    // Role permissions management
    private async Task ManageRolePermissions(RoleDTO role)
    {
        Console.WriteLine($"🔧 Abriendo modal de permisos para rol: {role.RoleName}");
        selectedRoleForPermissions = role;
        showRolePermissionModal = true;
        StateHasChanged();
    }

    private async Task ViewRolePermissions(RoleDTO role)
    {
        try
        {
            isLoadingRoles = true;
            StateHasChanged();

            var roleId = !string.IsNullOrEmpty(role.RoleId) ? role.RoleId : role.RoleName;

            Console.WriteLine($"📋 Obteniendo permisos para rol: {role.RoleName} (ID: {roleId})");

            var permissions = await permissionService.GetRolePermissionsAsync(roleId);

            if (permissions?.Permissions != null && permissions.Permissions.Any())
            {
                var permissionSummary = permissions.Permissions
                    .Where(p => p.CanView || p.CanCreate || p.CanEdit || p.CanDelete)
                    .Select(p => $"• {p.NavigationItemTitle}: {GetPermissionSummary(p)}")
                    .Take(10)
                    .ToList();

                var usersCount = GetUsersInRoleCount(role.RoleName);
                var message = $"Permisos del rol {role.RoleName} ({usersCount} usuarios):\n\n";

                if (permissionSummary.Any())
                {
                    message += string.Join("\n", permissionSummary);

                    if (permissions.Permissions.Count > 10)
                    {
                        message += $"\n\n... y {permissions.Permissions.Count - 10} permisos más.";
                    }
                }
                else
                {
                    message += "No tiene permisos específicos asignados.";
                }

                await JSRuntime.InvokeVoidAsync("alert", message);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert",
                    $"El rol {role.RoleName} no tiene permisos específicos asignados.\n\n" +
                    "Los usuarios con este rol tendrán acceso básico según las configuraciones predeterminadas del sistema.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al obtener permisos del rol: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");

            await displayMessage.DisplayErrorMessage(
                $"Error al obtener permisos del rol {role.RoleName}: {ex.Message}");
        }
        finally
        {
            isLoadingRoles = false;
            StateHasChanged();
        }
    }

    // Navigation permissions management
    private async Task ManageNavigationPermissions(NavigationItemDto item)
    {
        Console.WriteLine($"🗺️ Abriendo modal de permisos para navegación: {item.Title}");
        selectedNavigationItem = item;
        showNavigationPermissionModal = true;
        StateHasChanged();
    }

    // Tools - Métodos originales
    private async Task ShowPermissionMatrix()
    {
        showMatrixModal = true;
        StateHasChanged();
    }

    private async Task ShowBulkAssignment()
    {
        showBulkModal = true;
        StateHasChanged();
    }

    // Tools - Nuevos métodos para herramientas avanzadas
    private async Task ShowCopyPermissions()
    {
        Console.WriteLine("🛠️ Abriendo herramienta de copia de permisos");
        showCopyToolModal = true;
        StateHasChanged();
    }

    private async Task ShowResetPermissions()
    {
        Console.WriteLine("🛠️ Abriendo herramienta de reseteo de permisos");
        showResetModal = true;
        StateHasChanged();
    }

    private async Task ShowPermissionsReport()
    {
        Console.WriteLine("🛠️ Abriendo herramienta de reportes");
        showReportModal = true;
        StateHasChanged();
    }

    private async Task ShowAuditLog()
    {
        Console.WriteLine("🛠️ Abriendo herramienta de auditoría");
        showAuditModal = true;
        StateHasChanged();
    }

    // Métodos de utilidad
    private string GetPermissionSummary(NavigationPermissionDto permission)
    {
        var perms = new List<string>();
        if (permission.CanView) perms.Add("Ver");
        if (permission.CanCreate) perms.Add("Crear");
        if (permission.CanEdit) perms.Add("Editar");
        if (permission.CanDelete) perms.Add("Eliminar");
        return perms.Any() ? string.Join(", ", perms) : "Sin permisos";
    }
}