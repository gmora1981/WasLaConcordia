@using LaConcordia.Model
@using Identity.Api.Interfaces
@using System.Text
@using System.Text.Json
@inject IPermissionService permissionService
@inject IUsersRepository usersRepository
@inject IJSRuntime JSRuntime
@inject HttpClient httpClient
<link href="css/NavigationPermissionModal.css" rel="stylesheet" />
@if (showModal && selectedNavigationItem != null)
{
    <div class="modal-modern" @onclick="CloseModalBackground" @onclick:stopPropagation="false">
        <div class="modal-content-modern" style="max-width: 900px;" @onclick:stopPropagation="true">
            <div class="modal-header-modern">
                <h3 class="modal-title-modern">
                    <i class="fas fa-key"></i> Gestionar Permisos - @selectedNavigationItem.Title
                </h3>
                <button type="button" class="btn-close-modern" @onclick="CloseModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body-modern">
                <!-- Información del item de navegación -->
                <div class="navigation-info">
                    <div class="navigation-card-header">
                        <div class="navigation-avatar">
                            @if (!string.IsNullOrEmpty(selectedNavigationItem.Icon))
                            {
                                <i class="@selectedNavigationItem.Icon"></i>
                            }
                            else
                            {
                                <i class="fas fa-link"></i>
                            }
                        </div>
                        <div class="navigation-details">
                            <h4>@selectedNavigationItem.Title</h4>
                            @if (!string.IsNullOrEmpty(selectedNavigationItem.Url))
                            {
                                <p class="url-info">
                                    <i class="fas fa-link"></i> @selectedNavigationItem.Url
                                </p>
                            }
                            @if (!string.IsNullOrEmpty(selectedNavigationItem.RequiredRole))
                            {
                                <p class="role-required">
                                    <i class="fas fa-shield-alt"></i> Rol requerido: <strong>@selectedNavigationItem.RequiredRole</strong>
                                </p>
                            }
                            <p class="item-status">
                                Estado:
                                @if (selectedNavigationItem.IsActive)
                                {
                                    <span class="badge-active">✅ Activo</span>
                                }
                                else
                                {
                                    <span class="badge-inactive">❌ Inactivo</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Pestañas del modal -->
                <div class="tab-container">
                    <div class="tab-headers">
                        <button class="tab-header @GetTabActiveClass("roles")"
                                @onclick="@(() => SetActiveModalTab("roles"))">
                            <i class="fas fa-user-tag"></i> Permisos por Rol
                        </button>
                        <button class="tab-header @GetTabActiveClass("users")"
                                @onclick="@(() => SetActiveModalTab("users"))">
                            <i class="fas fa-users"></i> Permisos por Usuario
                        </button>
                        <button class="tab-header @GetTabActiveClass("settings")"
                                @onclick="@(() => SetActiveModalTab("settings"))">
                            <i class="fas fa-cog"></i> Configuración
                        </button>
                    </div>

                    <div class="tab-content" style="min-height: 400px; margin-top: 1rem;">
                        @if (activeModalTab == "roles")
                        {
                            <div class="tab-pane">
                                <div class="tab-description">
                                    <p><strong>Permisos por Rol</strong> - Define qué roles pueden acceder a este elemento y con qué permisos</p>
                                </div>

                                @if (isLoadingRolePermissions)
                                {
                                    <div class="loading-container">
                                        <div class="simple-spinner"></div>
                                        <p>Cargando permisos de roles...</p>
                                    </div>
                                }
                                else if (rolePermissions != null && rolePermissions.Any())
                                {
                                    <div class="permissions-list">
                                        @foreach (var rolePermission in rolePermissions)
                                        {
                                            <div class="permission-item">
                                                <div class="permission-header">
                                                    <h5>
                                                        <i class="fas @(rolePermission.RoleName == "Admin" ? "fa-crown" : "fa-user-tag")"></i>
                                                        @rolePermission.RoleName
                                                    </h5>
                                                    <small class="text-muted">@rolePermission.UsersCount usuarios en este rol</small>
                                                </div>
                                                <div class="permission-checkboxes">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               id="view-@rolePermission.RoleId"
                                                               @bind="rolePermission.CanView" />
                                                        <label class="form-check-label" for="view-@rolePermission.RoleId">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               id="create-@rolePermission.RoleId"
                                                               @bind="rolePermission.CanCreate" />
                                                        <label class="form-check-label" for="create-@rolePermission.RoleId">
                                                            <i class="fas fa-plus"></i> Crear
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               id="edit-@rolePermission.RoleId"
                                                               @bind="rolePermission.CanEdit" />
                                                        <label class="form-check-label" for="edit-@rolePermission.RoleId">
                                                            <i class="fas fa-edit"></i> Editar
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               id="delete-@rolePermission.RoleId"
                                                               @bind="rolePermission.CanDelete" />
                                                        <label class="form-check-label" for="delete-@rolePermission.RoleId">
                                                            <i class="fas fa-trash"></i> Eliminar
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="quick-actions">
                                                    <button class="btn-quick" @onclick="() => SelectAllPermissions(rolePermission)" title="Seleccionar todos">
                                                        <i class="fas fa-check-double"></i>
                                                    </button>
                                                    <button class="btn-quick" @onclick="() => ClearPermissions(rolePermission)" title="Limpiar todos">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="bulk-actions-section">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="ApplyToAllRoles">
                                            <i class="fas fa-users"></i> Aplicar a todos los roles
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearAllRolePermissions">
                                            <i class="fas fa-eraser"></i> Limpiar todos
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="fas fa-user-tag"></i>
                                        <p>No hay roles disponibles</p>
                                    </div>
                                }
                            </div>
                        }
                        else if (activeModalTab == "users")
                        {
                            <div class="tab-pane">
                                <div class="tab-description">
                                    <p><strong>Permisos por Usuario</strong> - Asigna permisos específicos a usuarios individuales para este elemento</p>
                                </div>

                                <!-- Búsqueda de usuarios -->
                                <div class="search-section">
                                    <div class="search-box">
                                        <i class="fas fa-search"></i>
                                        <input type="text" placeholder="Buscar usuario por nombre o email..."
                                               @bind="userSearchTerm" @bind:event="oninput"
                                               @onkeyup="SearchUsers" />
                                    </div>
                                    @if (!string.IsNullOrEmpty(userSearchTerm) && filteredUsers.Any())
                                    {
                                        <div class="search-results">
                                            @foreach (var user in filteredUsers.Take(5))
                                            {
                                                <div class="search-result-item" @onclick="() => AddUserPermission(user)">
                                                    <div class="user-avatar-small">
                                                        @((!string.IsNullOrEmpty(user.FirstName) ? user.FirstName.Substring(0, 1).ToUpper() : "?"))
                                                    </div>
                                                    <div class="user-info">
                                                        <strong>@user.FirstName @user.LastName</strong>
                                                        <small>@user.Email</small>
                                                    </div>
                                                    <i class="fas fa-plus-circle"></i>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>

                                @if (isLoadingUserPermissions)
                                {
                                    <div class="loading-container">
                                        <div class="simple-spinner"></div>
                                        <p>Cargando permisos de usuarios...</p>
                                    </div>
                                }
                                else if (userPermissions != null && userPermissions.Any())
                                {
                                    <div class="user-permissions-list">
                                        @foreach (var userPermission in userPermissions)
                                        {
                                            <div class="user-permission-item">
                                                <div class="user-info-section">
                                                    <div class="user-avatar-small">
                                                        @((!string.IsNullOrEmpty(userPermission.FirstName) ? userPermission.FirstName.Substring(0, 1).ToUpper() : "?"))
                                                    </div>
                                                    <div class="user-details">
                                                        <strong>@userPermission.FirstName @userPermission.LastName</strong>
                                                        <small>@userPermission.Email</small>
                                                    </div>
                                                </div>
                                                <div class="permission-checkboxes compact">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               @bind="userPermission.CanView" />
                                                        <label class="form-check-label">Ver</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               @bind="userPermission.CanCreate" />
                                                        <label class="form-check-label">Crear</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               @bind="userPermission.CanEdit" />
                                                        <label class="form-check-label">Editar</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                               @bind="userPermission.CanDelete" />
                                                        <label class="form-check-label">Eliminar</label>
                                                    </div>
                                                </div>
                                                <button class="btn-remove" @onclick="() => RemoveUserPermission(userPermission)" title="Quitar usuario">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="fas fa-user-plus"></i>
                                        <p>No hay permisos de usuario específicos</p>
                                        <small>Use la búsqueda para agregar usuarios</small>
                                    </div>
                                }
                            </div>
                        }
                        else if (activeModalTab == "settings")
                        {
                            <div class="tab-pane">
                                <div class="tab-description">
                                    <p><strong>Configuración del Elemento</strong> - Ajusta las propiedades del elemento de navegación</p>
                                </div>

                                <div class="settings-form">
                                    <div class="form-group">
                                        <label><i class="fas fa-heading"></i> Título</label>
                                        <input type="text" class="form-control" @bind="selectedNavigationItem.Title" />
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-link"></i> URL</label>
                                        <input type="text" class="form-control" @bind="selectedNavigationItem.Url"
                                               placeholder="/ruta/de/la/pagina" />
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-icons"></i> Icono (Font Awesome)</label>
                                        <input type="text" class="form-control" @bind="selectedNavigationItem.Icon"
                                               placeholder="fas fa-home" />
                                        @if (!string.IsNullOrEmpty(selectedNavigationItem.Icon))
                                        {
                                            <div class="icon-preview">
                                                Vista previa: <i class="@selectedNavigationItem.Icon"></i>
                                            </div>
                                        }
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-shield-alt"></i> Rol Requerido</label>
                                        <select class="form-control" @bind="selectedNavigationItem.RequiredRole">
                                            <option value="">Sin restricción</option>
                                            @if (availableRoles != null)
                                            {
                                                @foreach (var role in availableRoles)
                                                {
                                                    <option value="@role.RoleName">@role.RoleName</option>
                                                }
                                            }
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-sort"></i> Orden</label>
                                        <input type="number" class="form-control" @bind="selectedNavigationItem.Order" min="0" />
                                    </div>

                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="isActive"
                                                   @bind="selectedNavigationItem.IsActive" />
                                            <label class="form-check-label" for="isActive">
                                                <i class="fas fa-power-off"></i> Elemento Activo
                                            </label>
                                        </div>
                                    </div>

                                    @if (selectedNavigationItem.Children != null && selectedNavigationItem.Children.Any())
                                    {
                                        <div class="alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            Este elemento tiene @selectedNavigationItem.Children.Count() elementos hijos
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer-modern">
                @if (activeModalTab == "roles" || activeModalTab == "users")
                {
                    <button type="button" class="btn-modern btn-primary-modern" @onclick="SavePermissions" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="simple-spinner small"></span>
                            <text>Guardando...</text>
                        }
                        else
                        {
                            <i class="fas fa-save"></i>
                            <text>Guardar Permisos</text>
                        }
                    </button>
                }
                else if (activeModalTab == "settings")
                {
                    <button type="button" class="btn-modern btn-primary-modern" @onclick="SaveSettings" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="simple-spinner small"></span>
                            <text>Guardando...</text>
                        }
                        else
                        {
                            <i class="fas fa-save"></i>
                            <text>Guardar Configuración</text>
                        }
                    </button>
                }
                <button type="button" class="btn-modern btn-secondary-modern" @onclick="CloseModal">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool showModal { get; set; } = false;
    [Parameter] public NavigationItemDto? selectedNavigationItem { get; set; }
    [Parameter] public EventCallback OnModalClosed { get; set; }
    [Parameter] public EventCallback OnSettingsUpdated { get; set; }

    private string activeModalTab = "roles";
    private bool isLoadingRolePermissions = false;
    private bool isLoadingUserPermissions = false;
    private bool isSaving = false;

    // Búsqueda de usuarios
    private string userSearchTerm = "";
    private List<UserDTO> allUsers = new();
    private List<UserDTO> filteredUsers = new();

    // Permisos
    private List<NavigationRolePermission> rolePermissions = new();
    private List<NavigationUserPermission> userPermissions = new();
    private List<RoleDTO> availableRoles = new();


    protected override async Task OnParametersSetAsync()
    {
        if (showModal && selectedNavigationItem != null)
        {
            // Resetear el tab activo al abrir el modal
            activeModalTab = "roles";

            // Limpiar datos anteriores
            rolePermissions.Clear();
            userPermissions.Clear();
            userSearchTerm = "";
            filteredUsers.Clear();

            // Cargar datos iniciales
            await LoadInitialData();
        }
    }

    private async Task LoadInitialData()
    {
        try
        {
            // Cargar roles y usuarios disponibles
            await LoadRoles();
            await LoadUsers();

            // Cargar permisos según el tab activo
            if (activeModalTab == "roles")
            {
                await LoadRolePermissions();
            }
            else if (activeModalTab == "users")
            {
                await LoadUserPermissions();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando datos iniciales: {ex.Message}");
        }
    }

    private async Task LoadRoles()
    {
        try
        {
            var roles = await usersRepository.GetRoles();
            availableRoles = roles?.ToList() ?? new List<RoleDTO>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando roles: {ex.Message}");
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            var paginationDTO = new PaginationDTO { Page = 1, RecordsPerPage = 100 };
            var response = await usersRepository.GetUsers(paginationDTO);
            allUsers = response?.Response?.ToList() ?? new List<UserDTO>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando usuarios: {ex.Message}");
        }
    }

    private async Task LoadRolePermissions()
    {
        if (selectedNavigationItem == null) return;

        try
        {
            isLoadingRolePermissions = true;
            StateHasChanged();

            rolePermissions.Clear();

            foreach (var role in availableRoles)
            {
                try
                {
                    // Obtener permisos del rol para este item
                    var permission = await permissionService.GetRolePermissionForItemAsync(
                        role.RoleId, selectedNavigationItem.Id);

                    rolePermissions.Add(new NavigationRolePermission
                    {
                        RoleId = role.RoleId,
                        RoleName = role.RoleName,
                        UsersCount = 0, // Actualizar con conteo real si es necesario
                        CanView = permission?.CanView ?? false,
                        CanCreate = permission?.CanCreate ?? false,
                        CanEdit = permission?.CanEdit ?? false,
                        CanDelete = permission?.CanDelete ?? false
                    });
                }
                catch
                {
                    // Si no hay permisos, agregar con valores por defecto
                    rolePermissions.Add(new NavigationRolePermission
                    {
                        RoleId = role.RoleId,
                        RoleName = role.RoleName,
                        UsersCount = 0,
                        CanView = false,
                        CanCreate = false,
                        CanEdit = false,
                        CanDelete = false
                    });
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando permisos de roles: {ex.Message}");
        }
        finally
        {
            isLoadingRolePermissions = false;
            StateHasChanged();
        }
    }

    private async Task LoadUserPermissions()
    {
        if (selectedNavigationItem == null) return;

        try
        {
            isLoadingUserPermissions = true;
            StateHasChanged();

            userPermissions.Clear();

            // Cargar todos los usuarios que tienen permisos para este item de navegación
            foreach (var user in allUsers)
            {
                try
                {
                    // Intentar obtener los permisos del usuario para este item específico
                    var permission = await permissionService.GetUserPermissionForItemAsync(
                        user.UserId, selectedNavigationItem.Id);

                    // Si el usuario tiene permisos (cualquiera que sea true), agregarlo a la lista
                    if (permission != null &&
                        (permission.CanView || permission.CanCreate || permission.CanEdit || permission.CanDelete))
                    {
                        userPermissions.Add(new NavigationUserPermission
                        {
                            UserId = user.UserId,
                            FirstName = user.FirstName,
                            LastName = user.LastName,
                            Email = user.Email,
                            CanView = permission.CanView,
                            CanCreate = permission.CanCreate,
                            CanEdit = permission.CanEdit,
                            CanDelete = permission.CanDelete
                        });
                    }
                }
                catch (Exception ex)
                {
                    // Si hay error al obtener permisos de un usuario específico, continuar con el siguiente
                    Console.WriteLine($"No se pudieron cargar permisos para usuario {user.UserId}: {ex.Message}");
                }
            }

            Console.WriteLine($"✅ Permisos de usuario cargados: {userPermissions.Count} usuarios con permisos");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando permisos de usuarios: {ex.Message}");
        }
        finally
        {
            isLoadingUserPermissions = false;
            StateHasChanged();
        }
    }

    private async Task SetActiveModalTab(string tab)
    {
        activeModalTab = tab;

        if (tab == "roles")
        {
            await LoadRolePermissions();
        }
        else if (tab == "users")
        {
            await LoadUserPermissions();
        }

        StateHasChanged();
    }

    private string GetTabActiveClass(string tab)
    {
        return activeModalTab == tab ? "active" : "";
    }

    private void SearchUsers()
    {
        if (string.IsNullOrWhiteSpace(userSearchTerm))
        {
            filteredUsers.Clear();
        }
        else
        {
            var searchLower = userSearchTerm.ToLower();
            filteredUsers = allUsers.Where(u =>
                (u.Email?.ToLower().Contains(searchLower) == true) ||
                (u.FirstName?.ToLower().Contains(searchLower) == true) ||
                (u.LastName?.ToLower().Contains(searchLower) == true)
            ).ToList();
        }
        StateHasChanged();
    }

    private void AddUserPermission(UserDTO user)
    {
        // Verificar si el usuario ya está en la lista
        if (userPermissions.Any(up => up.UserId == user.UserId))
        {
            Console.WriteLine($"⚠️ El usuario {user.Email} ya tiene permisos asignados");
            // Opcionalmente, mostrar un mensaje al usuario
            _ = JSRuntime.InvokeVoidAsync("alert",
                $"El usuario {user.FirstName} {user.LastName} ya está en la lista de permisos.");
            return;
        }

        userPermissions.Add(new NavigationUserPermission
        {
            UserId = user.UserId,
            FirstName = user.FirstName,
            LastName = user.LastName,
            Email = user.Email,
            CanView = false,
            CanCreate = false,
            CanEdit = false,
            CanDelete = false
        });

        userSearchTerm = "";
        filteredUsers.Clear();
        StateHasChanged();
    }

    private async Task RemoveUserPermission(NavigationUserPermission userPermission)
    {
        try
        {
            // Si el usuario tenía permisos guardados, eliminarlos del backend
            if (selectedNavigationItem != null)
            {
                var response = await httpClient.DeleteAsync(
                    $"/api/permissions/user/{userPermission.UserId}/item/{selectedNavigationItem.Id}");

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"✅ Permisos eliminados para {userPermission.Email}");
                }
            }

            userPermissions.Remove(userPermission);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al eliminar permisos: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert",
                $"Error al eliminar permisos: {ex.Message}");
        }
    }

    private void SelectAllPermissions(NavigationRolePermission rolePermission)
    {
        rolePermission.CanView = true;
        rolePermission.CanCreate = true;
        rolePermission.CanEdit = true;
        rolePermission.CanDelete = true;
        StateHasChanged();
    }

    private void ClearPermissions(NavigationRolePermission rolePermission)
    {
        rolePermission.CanView = false;
        rolePermission.CanCreate = false;
        rolePermission.CanEdit = false;
        rolePermission.CanDelete = false;
        StateHasChanged();
    }

    private void ApplyToAllRoles()
    {
        foreach (var role in rolePermissions)
        {
            role.CanView = true;
            // Opcionalmente, puedes configurar otros permisos
        }
        StateHasChanged();
    }

    private void ClearAllRolePermissions()
    {
        foreach (var role in rolePermissions)
        {
            role.CanView = false;
            role.CanCreate = false;
            role.CanEdit = false;
            role.CanDelete = false;
        }
        StateHasChanged();
    }

    private async Task SavePermissions()
    {
        if (selectedNavigationItem == null) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            var saveCount = 0;
            var errorCount = 0;

            // Guardar permisos de roles
            if (activeModalTab == "roles")
            {
                foreach (var rolePermission in rolePermissions)
                {
                    try
                    {
                        var updateDto = new
                        {
                            RoleId = rolePermission.RoleId,
                            NavigationItemId = selectedNavigationItem.Id,
                            CanView = rolePermission.CanView,
                            CanCreate = rolePermission.CanCreate,
                            CanEdit = rolePermission.CanEdit,
                            CanDelete = rolePermission.CanDelete
                        };

                        var json = JsonSerializer.Serialize(updateDto);
                        var content = new StringContent(json, Encoding.UTF8, "application/json");

                        var response = await httpClient.PostAsync("/api/permissions/role/update", content);

                        if (response.IsSuccessStatusCode)
                        {
                            saveCount++;
                        }
                        else
                        {
                            errorCount++;
                        }
                    }
                    catch
                    {
                        errorCount++;
                    }
                }
            }
            // Guardar permisos de usuarios
            else if (activeModalTab == "users")
            {
                foreach (var userPermission in userPermissions)
                {
                    try
                    {
                        var updateDto = new
                        {
                            UserId = userPermission.UserId,
                            NavigationItemId = selectedNavigationItem.Id,
                            CanView = userPermission.CanView,
                            CanCreate = userPermission.CanCreate,
                            CanEdit = userPermission.CanEdit,
                            CanDelete = userPermission.CanDelete
                        };

                        var json = JsonSerializer.Serialize(updateDto);
                        var content = new StringContent(json, Encoding.UTF8, "application/json");

                        var response = await httpClient.PostAsync("/api/permissions/user/update", content);

                        if (response.IsSuccessStatusCode)
                        {
                            saveCount++;
                        }
                        else
                        {
                            errorCount++;
                        }
                    }
                    catch
                    {
                        errorCount++;
                    }
                }
            }

            var message = saveCount > 0
                ? $"✅ {saveCount} permisos guardados exitosamente"
                : "❌ No se pudieron guardar los permisos";

            if (errorCount > 0)
            {
                message += $"\n⚠️ {errorCount} permisos tuvieron errores";
            }

            await JSRuntime.InvokeVoidAsync("alert", message);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al guardar permisos: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task SaveSettings()
    {
        // TODO: Implementar guardado de configuración del elemento de navegación
        await OnSettingsUpdated.InvokeAsync();
        await JSRuntime.InvokeVoidAsync("alert", "Configuración guardada exitosamente");
    }

    private async Task CloseModal()
    {
        activeModalTab = "roles";
        rolePermissions.Clear();
        userPermissions.Clear();
        userSearchTerm = "";
        filteredUsers.Clear();

        await OnModalClosed.InvokeAsync();
    }

    private async Task CloseModalBackground(MouseEventArgs e)
    {
        await CloseModal();
    }
}

