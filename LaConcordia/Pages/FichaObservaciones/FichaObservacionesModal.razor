@using LaConcordia.DTO
@using LaConcordia.Interface
@inject IFichaobservacione fichaobservacioneRepo

@if (IsVisible)
{
    <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CerrarModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true" style="max-width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Observaciones de la cédula: @Cedula</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Izquierda: tabla observaciones -->
                        <div class="col-md-7" style="max-height: 400px; overflow-y: auto;">
                            @if (observaciones != null && observaciones.Count > 0)
                            {
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Observación</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var obs in observaciones)
                                        {
                                            <tr style="cursor:pointer" @onclick="() => SeleccionarObservacion(obs)">
                                                <td>@obs.Fecha?.ToShortDateString()</td>
                                                <td>@obs.Motivo</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <Pagination TotalItems="@totalObservaciones"
                                            PageSize="@pageSizeObservaciones"
                                            CurrentPage="@paginaObservaciones"
                                            OnPageChanged="CambiarPagina" />
                            }
                            else
                            {
                                <p>No hay observaciones para esta cédula.</p>
                            }
                        </div>

                        <!-- Derecha: formulario nueva observación -->
                        <div class="col-md-5 border-start ps-3">
                            <h6>Nueva Observación</h6>
                            <EditForm Model="nuevaObservacion" OnValidSubmit="GuardarNuevaObservacion">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="mb-3">
                                    <label class="form-label">Fecha</label>
                                    <InputDate class="form-control" @bind-Value="nuevaObservacion.Fecha" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Unidad</label>
                                    <InputText class="form-control" rows="5" @bind-Value="nuevaObservacion.Fkunidad" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Motivo</label>
                                    <InputTextArea class="form-control" rows="5" @bind-Value="nuevaObservacion.Motivo" />
                                </div>

                                <button type="submit" class="btn btn-primary" disabled="@(!PuedeGuardarNueva || guardando)">
                                    @if (guardando)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true">Guardando...</span>
                                        
                                    }
                                    else
                                    {
                                        <span>Guardar</span>
                                    }
                                </button>
                            </EditForm>

                            @if (observacionSeleccionada != null)
                            {
                                <hr />
                                <h6>Observación seleccionada</h6>
                                <div class="mb-3">
                                    <label class="form-label">Fecha</label>
                                    <InputDate class="form-control" @bind-Value="observacionSeleccionada.Fecha" Disabled="true" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Unidad</label>
                                    <InputTextArea class="form-control" rows="5" @bind-Value="observacionSeleccionada.Fkunidad" Disabled="true" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Motivo</label>
                                    <InputTextArea class="form-control" rows="5" @bind-Value="observacionSeleccionada.Motivo" Disabled="true" />
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CerrarModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Cedula { get; set; } = "";

    [Parameter]
    public EventCallback OnClose { get; set; }

    private bool IsVisible { get; set; } = false;

    private List<FichaobservacioneDTO> observaciones = new();
    private int paginaObservaciones = 1;
    private int pageSizeObservaciones = 5;
    private int totalObservaciones = 0;

    private bool guardando = false;

    // Modelo para nueva observación
    private FichaobservacioneDTO nuevaObservacion = new();

    // Observación seleccionada de la tabla para mostrar detalles (solo lectura)
    private FichaobservacioneDTO? observacionSeleccionada;

    public async Task Show(string cedula)
    {
        Cedula = cedula;
        paginaObservaciones = 1;
        IsVisible = true;
        observacionSeleccionada = null;
        nuevaObservacion = new FichaobservacioneDTO
        {
            Fkcedula = Cedula,
            Fecha = DateOnly.FromDateTime(DateTime.Now) // fecha actual por defecto
        };
        await CargarObservaciones();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarObservaciones()
    {
        var resultado = await fichaobservacioneRepo.GetFichaObservacionePaginadosByCedula(paginaObservaciones, pageSizeObservaciones, Cedula);
        observaciones = resultado.Items;
        totalObservaciones = resultado.TotalItems;
    }

    private async Task CambiarPagina(int nuevaPagina)
    {
        paginaObservaciones = nuevaPagina;
        await CargarObservaciones();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CerrarModal()
    {
        IsVisible = false;
        observaciones.Clear();
        observacionSeleccionada = null;
        await OnClose.InvokeAsync(null);
        await InvokeAsync(StateHasChanged);
    }

    private async Task GuardarNuevaObservacion()
    {
        try
        {
            guardando = true;
            // Forzar que la cedula esté igual al parámetro
            nuevaObservacion.Fkcedula = Cedula;

            await fichaobservacioneRepo.InsertFichaObservacione(nuevaObservacion);

            // Recargar listado de observaciones
            await CargarObservaciones();

            // Limpiar formulario para nueva observación
            nuevaObservacion = new FichaobservacioneDTO
            {
                Fkcedula = Cedula,
                Fecha = DateOnly.FromDateTime(DateTime.Now)
            };

            guardando = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            guardando = false;
            Console.Error.WriteLine($"Error al guardar observación: {ex.Message}");
        }
    }

    private bool PuedeGuardarNueva =>
        !string.IsNullOrWhiteSpace(nuevaObservacion.Motivo) &&
        nuevaObservacion.Fecha != null &&
        !guardando;

    private void SeleccionarObservacion(FichaobservacioneDTO obs)
    {
        observacionSeleccionada = obs;
    }
}
