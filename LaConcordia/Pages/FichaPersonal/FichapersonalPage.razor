@page "/ficha-persona"
@using LaConcordia.DTO
@using LaConcordia.Interface
@using LaConcordia.Pages.FichaObservaciones
@using LaConcordia.Pages.SeguroVidum
@using LaConcordia.Pagination
@inject IFichapersonal fichaRepo
@inject IJSRuntime JS
@inject IDisplayMessage displayMessage
@inject INacionalidad nacionalidadRepo
@inject IUnidad unidadRepo
@inject ITipolicencium tipolicenciaRepo
@inject ICargo cargoRepo
@inject IDuenopuesto duenopuestoRepo
@inject IFichaobservacione fichaobservacioneRepo
@inject ISegurovidum segurovidumRepo
@inject IParentesco parentescoRepo

<h3>Control Ficha Personal</h3>

<!-- Encabezado: Nuevo, Buscar -->

<div class="card mb-3 p-3 shadow-sm">
    <div class="d-flex flex-wrap align-items-center gap-2">
        <button class="btn btn-primary d-flex align-items-center" @onclick="NuevoRegistro">
            <i class="bi bi-plus-circle me-1"></i> Nuevo
        </button>

        <div class="flex-grow-1">
            <input type="text" class="form-control" placeholder="Buscar por Cédula, Nombre o Apellidos..." @bind="razonBusqueda" />
        </div>

        <select class="form-select w-auto" @bind="estadoFiltro">
            <option value="a">Activo</option>
            <option value="p">Pasivo</option>
        </select>

        <button class="btn btn-success d-flex align-items-center" @onclick="BuscarFichas">
            <i class="bi bi-search me-1"></i> Buscar
        </button>
    </div>
</div>

<!-- Paginación -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div class="flex-grow-1">
        <p class="text-muted mb-0">Total: @TotalUsuarios | Página: @PaginaActual</p>
    </div>
    <div class="d-flex justify-content-center flex-grow-1">
        <Pagination TotalItems="@TotalUsuarios"
        PageSize="@PageSize"
        CurrentPage="@PaginaActual"
        OnPageChanged="OnPageChangedAsync" />
    </div>
    <div class="flex-grow-1 text-end"></div>
</div>

<!-- Tabla de fichas personales -->

<table class="table table-bordered table-hover table-striped mt-3 shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>Cédula</th>
            <th>Apellidos</th>
            <th>Nombre</th>
            <th>Celular</th>
            <th>Fecha Nac.</th>
            <th>Ingreso</th>
            <th>Estado</th>
            <th>Observaciones</th>
            <th>Beneficiarios</th>
            <th>Doc. Completos</th>
        </tr>
    </thead>
    <tbody>
        @if (fichas != null && fichas.Count > 0)
        {
            @foreach (var ficha in fichas)
            {
                <tr @onclick="() => SeleccionarFicha(ficha)" class="@(ficha == fichaSeleccionada ? "table-primary" : "")" style="cursor: pointer;">
                    <td>@ficha.Cedula</td>
                    <td>@ficha.Apellidos</td>
                    <td>@ficha.Nombre</td>
                    <td>@ficha.Celular</td>
                    <td>@ficha.Fechanacimiento?.ToShortDateString()</td>
                    <td>@ficha.Fechaingreso?.ToShortDateString()</td>
                    <td>
                        <span class="badge @(ficha.Estado == "a" ? "bg-success" : "bg-secondary")">
                            @(ficha.Estado == "a" ? "Activo" : "Pasivo")
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning d-flex align-items-center"
                                style="font-size: 1rem; padding: 0.5rem 1rem;"
                                @onclick="() => AbrirModalObservaciones(ficha.Cedula, ficha.Fkunidad)"
                                @onclick:stopPropagation="true"
                                title="Ver Observaciones">
                            <i class="bi bi-card-text me-1 fs-5"></i> Observaciones
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm"
                                style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"
                                @onclick="() => AbrirModalBeneficiarios(ficha.Cedula)"
                                @onclick:stopPropagation="true"
                                title="Ver Beneficiarios">
                            <i class="bi bi-card-text me-1"></i> Beneficiarios
                        </button>
                    </td>
                    <td>
                    <td>
                        @(string.IsNullOrWhiteSpace(ficha.Documentacion) ? "INCOMPLETA" : ficha.Documentacion)
                    </td>
                        @* <InputSelect class="form-select" @bind-Value="ficha.Documentacion">
                            <option value="INCOMPLETA" selected="@(string.IsNullOrEmpty(ficha.Documentacion) ? true : false)">INCOMPLETA</option>
                            <option value="COMPLETA">COMPLETA</option>
                        </InputSelect> *@
                    </td>

                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="9" class="text-center text-muted">No se encontraron registros.</td>
            </tr>
        }
    </tbody>
</table>



<!-- IMAGENES -->
<div class="row">
    <!-- Sección 1: Documentos del chofer -->
    <div class="col-6 border p-3 mb-3">
        <h5>
            Documento Frontal / Trasera

        </h5>

        <!-- Frontal -->
        <div class="mb-2 d-flex align-items-center">
            <InputFile OnChange='@(e => OnFileSelected(e, "FRONTAL"))' />
            <span class="ms-2 status-circle"
                  style="background-color:@(estadoImagen?.Frontal == true ? "green" : "red")">
            </span>
            <label class="ms-2">Frontal</label>
        </div>

        <!-- Trasera -->
        <div class="mb-2 d-flex align-items-center">
            <InputFile OnChange='@(e => OnFileSelected(e, "TRASERA"))' />
            <span class="ms-2 status-circle"
                  style="background-color:@(estadoImagen?.Trasera == true ? "green" : "red")">
            </span>
            <label class="ms-2">Trasera</label>
        </div>
    </div>

    <!-- Sección 2: Licencia -->
    <div class="col-6 border p-3 mb-3">
        <h5>
            Licencia
            <span class="status-circle" style="background-color:@(estadoImagen?.Licencia == true ? "green" : "red")"></span>
        </h5>
        <InputFile OnChange='@(e => OnFileSelected(e, "LICENCIA"))' />
    </div>

    <!-- Sección 3: Matrícula -->
    @* <div class="col-6 border p-3 mb-3">
        <h5>
            Matrícula
            <span class="status-circle" style="background-color:@(estadoImagen?.Matricula == true ? "green" : "red")"></span>
        </h5>
        <InputFile OnChange='@(e => OnFileSelected(e, "MATRICULA"))' />
    </div> *@
    <!-- Matrícula Frontal -->
    <div class="col-6 border p-3 mb-3">
        <h5>
            Matrícula Frontal / Trasera
        </h5>
        <InputFile OnChange='@(e => OnFileSelected(e, "MATRICULA_FRONTAL"))' />
        <span class="ms-2 status-circle"
              style="background-color:@(estadoImagen?.MatriculaFrontal == true ? "green" : "red")">
        </span>
        <label class="ms-2">Frontal</label>
   

    <!-- Matrícula Trasera -->
    <div class="mb-2 d-flex align-items-center">
        <InputFile OnChange='@(e => OnFileSelected(e, "MATRICULA_TRASERA"))' />
        <span class="ms-2 status-circle"
              style="background-color:@(estadoImagen?.MatriculaTrasera == true ? "green" : "red")">
        </span>
        <label class="ms-2">Trasera</label>
    </div>

    </div>
    <!-- Sección 4: Vehículo -->
    <div class="col-6 border p-3 mb-3">
        <h5>
            Vehículo
            <span class="status-circle" style="background-color:@(estadoImagen?.Vehiculo == true ? "green" : "red")"></span>
        </h5>
        <InputFile OnChange='@(e => OnFileSelected(e, "VEHICULO"))' />
    </div>
</div>

<style>
    .status-circle {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #00000033;
        vertical-align: middle;
    }
</style>

<EditForm Model="fichaSeleccionada">
        <div class="row">
            <!-- Columna 1 -->
            <div class="col-md-6">
                

                <div class="mb-2">
                    <label class="form-label">Cedula</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Cedula"  disabled="@(!esNuevo)" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Apellidos</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Apellidos"  />
                </div>
                <div class="mb-2">
                    <label class="form-label">Telefono</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Telefono" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha Nacimiento</label>
                    <InputDate class="form-control" @bind-Value="fichaSeleccionada.Fechanacimiento" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Domicilio</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Domicilio" />
                </div>

                <!-- Tipo Licencia -->
                <div class="mb-2">
                    <label class="form-label">Tipo Licencia</label>
                    <InputSelect class="form-select" @bind-Value="fichaSeleccionada.Fktipolicencia">
                        <option value="">-- Seleccione Tipo Licencia --</option>
                        @foreach (var tipo in listaTipoLicencia)
                        {
                            <option value="@tipo.Idtipo">@tipo.Tipolicencia</option>
                        }
                    </InputSelect>
                </div>

                <!-- Cargo -->
                <div class="mb-2">
                    <label class="form-label">Cargo</label>
                    <InputSelect class="form-select" @bind-Value="fichaSeleccionada.Fkcargo">
                        <option value="">-- Seleccione Cargo --</option>
                        @foreach (var tipo in listaCargos)
                        {
                            <option value="@tipo.Idcargo">@tipo.Cargo1</option>
                        }
                    </InputSelect>
                </div>

            <!-- Documentos completos -->
            <div class="mb-2">
                <label class="form-label">Documentación Completa</label>
                <InputSelect class="form-select" @bind-Value="fichaSeleccionada.Documentacion">
                    <option value="INCOMPLETA" selected="@(string.IsNullOrEmpty(fichaSeleccionada.Documentacion))">INCOMPLETA</option>
                    <option value="COMPLETA">COMPLETA</option>
                </InputSelect>
            </div>
            </div>

            <!-- Columna 2 -->
            <div class="col-md-6">
                <div class="mb-2">
                    <label class="form-label">Nombre</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Nombre"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Correo</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Correo"  />
                </div>
                <div class="mb-2">
                    <label class="form-label">Celular</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Celular"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha Ingreso</label>
                    <InputDate class="form-control" @bind-Value="fichaSeleccionada.Fechaingreso" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Referencia</label>
                    <InputText class="form-control mb-2" @bind-Value="fichaSeleccionada.Referencia"  />
                </div>

                <!-- Nacionalidad -->
                <div class="mb-2">
                    <label class="form-label">Nacionalidad</label>
                    <InputSelect class="form-select" @bind-Value="fichaSeleccionada.Fknacionalidad">
                        <option value="">-- Seleccione Nacionalidad --</option>
                        @foreach (var nac in listaNacionalidad)
                        {
                            <option value="@nac.Idnacionalidad">@nac.Nacionalidad1</option>
                        }
                    </InputSelect>
                </div>
                <div class="mb-2">
                    <label class="form-label">CUOTA</label>
                    <InputNumber class="form-control mb-2" @bind-Value="fichaSeleccionada.Cuotaf" />
                </div>
            </div>

            <!-- Sección Gestión de Unidad -->
            <div class="card mb-3 p-3 border">
            <h6 class="card-title"><i class="bi bi-truck"></i> Gestión de Unidad</h6>

                <div class="row">
                    <div class="col-md-4">
                        <InputText class="form-control mb-2" @bind-Value="codigoUnidad" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary" @onclick="BuscarUnidad">Buscar Unidad</button>
                    </div>
                </div>

                @if (unidadEncontrada is not null)
                {
                    <div class="row">
                        <div class="col-md-4"><strong>Placa:</strong> @unidadEncontrada.Placa</div>
                        <div class="col-md-4"><strong>Propietario:</strong> @unidadEncontrada.Propietario</div>
                        <div class="col-md-4"><strong>Marca:</strong> @unidadEncontrada.Marca</div>
                        <div class="col-md-4"><strong>Modelo:</strong> @unidadEncontrada.Modelo</div>
                        <div class="col-md-4"><strong>Color:</strong> @unidadEncontrada.Color</div>
                        <div class="col-md-4"><strong>Año:</strong> @unidadEncontrada.Anio</div>
                        <div class="col-md-4"><strong>Fecha:</strong> @unidadEncontrada.Fecha?.ToShortDateString()</div>
                    </div>
                }
            </div>

            <!-- Sección Gestión de Dueño del Puesto -->
            <div class="card mb-3 p-3 border">
            <h6 class="card-title"><i class="bi bi-truck"></i> Gestión del Dueño Del Puesto</h6>

                <div class="row">
                    <div class="col-md-4">
                        <InputText class="form-control mb-2"@bind-Value="cedulaDuenopuesto" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary" @onclick="BuscarDuenopuesto">Buscar Dueño</button>
                    </div>
                </div>

                @if (duenopuestoEncontrado is not null)
                {
                    <div class="row">
                        <div class="col-md-6"><strong>Nombres:</strong> @duenopuestoEncontrado.Nombres</div>
                        <div class="col-md-6"><strong>Apellidos:</strong> @duenopuestoEncontrado.Apellidos</div>
                    </div>
                }
            </div>

            <!-- Estado en toda la fila -->
            <div class="col-md-12">
                <InputSelect class="form-control mb-2" @bind-Value="fichaSeleccionada.Estado">
                    <option value="">-- Estado --</option>
                    <option value="a">Activo</option>
                    <option value="p">Pasivo</option>
                </InputSelect>
            </div>
        </div>
    </EditForm>

    <div class="d-flex gap-2 mt-2">
        @* <button class="btn btn-warning" @onclick="GuardarCambios" disabled="@(!PuedeGuardar)">Actualizar</button> *@
        <button class="btn btn-warning" @onclick="GuardarCambios" disabled="@(!PuedeGuardar)">
            @(esNuevo ? "Guardar" : "Actualizar")
        </button>

        <button class="btn btn-danger" @onclick="EliminarFicha" disabled="@(!PuedeEliminar)">Eliminar</button>
        <button class="btn btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
        <div class="ms-2">
            <button class="btn btn-info" @onclick="ExportarFicha">
                Exportar PDF <i class="bi bi-file-earmark-pdf-fill"></i>
            </button>
        </div>
        <div class="ms-2">
            <button class="btn btn-info" @onclick="ExportarImagenesChofer">
                Exportar PDF imagenes<i class="bi bi-file-earmark-pdf-fill"></i>
            </button>
        </div>
    </div>



<FichaObservacionesModal @ref="modalObservaciones" OnClose="CerrarModalObservaciones" />

<SegurovidumModal @ref="modalBeneficiarios" Parentesco="listaParentesco" />



@code {
    // Listado paginado de fichas personales
    private List<FichapersonalDTO> fichas = new();

    // Registro seleccionado para mostrar y editar
    private FichapersonalDTO fichaSeleccionada = new();

    // Listas para los combos de selección
    private List<NacionalidadDTO> listaNacionalidad = new();
    private List<TipolicenciumDTO> listaTipoLicencia = new();
    private List<CargoDTO> listaCargos = new();

    // Filtros y controles de búsqueda
    private string razonBusqueda = string.Empty;
    private string estadoFiltro = string.Empty;
    private bool esNuevo = false;
    private string textoBoton = "Nuevo";


    // Para gestión de unidad y dueño del puesto
    private string codigoUnidad = string.Empty;
    private UnidadDTO? unidadEncontrada;
    private string cedulaDuenopuesto = string.Empty;
    private DuenopuestoDTO? duenopuestoEncontrado;
    private FichaObservacionesModal modalObservaciones;


    // Paginación
    private int PaginaActual = 1;
    private int PageSize = 8;
    private int TotalUsuarios = 0;

    // Para las observaciones y paginación en modal
    private List<FichaobservacioneDTO> observaciones = new();
    private string cedulaObservacionesActual = string.Empty;
    private int paginaObservaciones = 1;
    private int pageSizeObservaciones = 5;
    private int totalObservaciones = 0;
    private bool modalObservacionesVisible = false;

    private async Task AbrirModalObservaciones(string cedula, string fkunidad)
    {
        await modalObservaciones.Show(cedula, fkunidad);
    }

    private async Task CargarObservaciones()
    {
        var resultado = await fichaobservacioneRepo.GetFichaObservacionePaginadosByCedula(
            paginaObservaciones, pageSizeObservaciones, cedulaObservacionesActual);

        observaciones = resultado.Items;
        totalObservaciones = resultado.TotalItems;
    }

    private void CerrarModalObservaciones()
    {
        StateHasChanged();
    }

    //beneficiarios
    private List<ParentescoDTO> listaParentesco = new();

    private SegurovidumModal modalBeneficiarios;

    private async Task AbrirModalBeneficiarios(string cedula)
    {
        await modalBeneficiarios.Show(cedula);
    }
    private List<SegurovidumDTO> beneficiarios = new();
    private int paginaBeneficiarios = 1;
    private int pageSizeBeneficiarios = 10; // o el tamaño que quieras
    private PagedResult<SegurovidumDTO> beneficiariosPaginados = new();

    private async Task CargarBeneficiarios(string cedula)
    {
        if (!string.IsNullOrWhiteSpace(cedula))
        {
            beneficiariosPaginados = await segurovidumRepo.GetSegurovidumPaginadosByCedulaAfiliado(paginaBeneficiarios, pageSizeBeneficiarios, cedula);
            beneficiarios = beneficiariosPaginados.Items;
        }
    }

    // Inicialización al cargar la página
    protected override async Task OnInitializedAsync()
    {
        await CargarListasRelacionadas();  // Cargar listas para combos
        await CargarFichasAsync();          // Cargar listado de fichas

    }

    // Método que carga los datos para combos
    private async Task CargarListasRelacionadas()
    {

        listaParentesco = await parentescoRepo.ParentescoInfoAll();
        listaCargos = await cargoRepo.GetCargoInfoAll();
        listaTipoLicencia = await tipolicenciaRepo.GetTipolicenciaInfoAll();
        listaNacionalidad = await nacionalidadRepo.GetNacionalidadesAll();
    }

    // Carga el listado de fichas según filtros y paginación
    private async Task CargarFichasAsync()
    {
        var resultado = await fichaRepo.GetFichaPersonalPaginados(PaginaActual, PageSize, razonBusqueda, estadoFiltro);
        fichas = resultado.Items;
        TotalUsuarios = resultado.TotalItems;
    }

    // Acción del botón Buscar
    private async Task BuscarFichas()
    {
        PaginaActual = 1;
        await CargarFichasAsync();
    }

    // Busca el dueño del puesto por cédula
    private async Task BuscarDuenopuesto()
    {
        if (!string.IsNullOrWhiteSpace(cedulaDuenopuesto))
        {
            var resultado = await duenopuestoRepo.GetDuenopuestoByCedula(cedulaDuenopuesto);
            if (resultado is not null && resultado.Estado == "a")
            {
                duenopuestoEncontrado = resultado;
                fichaSeleccionada.Fkdpuesto = resultado.Cedula;
            }
            else
            {
                duenopuestoEncontrado = null;
                await JS.InvokeVoidAsync("alert", "Dueño no encontrado o inactivo.");
            }
        }
    }

    // Selecciona un registro de la tabla para editar
    private async Task SeleccionarFicha(FichapersonalDTO ficha)
    {
        await CargarBeneficiarios(ficha.Cedula);

        esNuevo = false;
        StateHasChanged(); // refrescar UI

        // Cargar listas para que los combos tengan opciones y puedan seleccionar valor
        await CargarListasRelacionadas();

        // Copiar datos del registro seleccionado
        fichaSeleccionada = new FichapersonalDTO
            {
                Cedula = ficha.Cedula,
                Nombre = ficha.Nombre,
                Apellidos = ficha.Apellidos,
                Correo = ficha.Correo,
                Telefono = ficha.Telefono,
                Celular = ficha.Celular,
                Fechanacimiento = ficha.Fechanacimiento,
                Fechaingreso = ficha.Fechaingreso,
                Domicilio = ficha.Domicilio,
                Referencia = ficha.Referencia,
                Estadoservicio = ficha.Estadoservicio,
                Cuotaf = ficha.Cuotaf,
                Estado = ficha.Estado,
                Fknacionalidad = ficha.Fknacionalidad,
                Fkunidad = ficha.Fkunidad,
                Fkdpuesto = ficha.Fkdpuesto,
                Fkcargo = ficha.Fkcargo,
                Fktipolicencia = ficha.Fktipolicencia,
                Documentacion = string.IsNullOrEmpty(ficha.Documentacion) ? "INCOMPLETA" : ficha.Documentacion
            };

        // Reiniciar datos relacionados
        unidadEncontrada = null;
        duenopuestoEncontrado = null;

        // Guardar código unidad y cédula dueño para buscar detalles relacionados
        codigoUnidad = ficha.Fkunidad ?? string.Empty;
        cedulaDuenopuesto = ficha.Fkdpuesto ?? string.Empty;

        // Buscar datos relacionados
        await BuscarUnidad();
        await BuscarDuenopuesto();

        // 🔹 Actualizar estado de imágenes
        await ActualizarEstadoImagenes(ficha.Cedula);

        esNuevo = false;
        StateHasChanged(); // Refrescar UI
    }

    // Crea un nuevo registro en blanco
    private void NuevoRegistro()
    {
        fichaSeleccionada = new FichapersonalDTO();
        unidadEncontrada = null;
        duenopuestoEncontrado = null;
        codigoUnidad = string.Empty;
        cedulaDuenopuesto = string.Empty;

        // archivoSeleccionado = null;
        archivoFrontal = null;
        archivoTrasera = null;
        archivoLicencia = null;
        // archivoMatricula = null;
        archivoMatriculaFrontal = null;
        archivoMatriculaTrasera = null;
        archivoVehiculo = null;
        esNuevo = true; // Indica que es un registro nuevo
    }

    private async Task GuardarCambios()
    {
        try
        {
            if (esNuevo)
            {
                await fichaRepo.InsertFichaPersonal(fichaSeleccionada);
            }
            else
            {
                await fichaRepo.UpdateFichaPersonal(fichaSeleccionada);
            }

            // Subir archivos si hay
            try
            {
                var tareas = new List<Task>();

                if (archivoFrontal != null) { tareas.Add(SubirImagen(archivoFrontal, "FRONTAL")); archivoFrontal = null; }
                if (archivoTrasera != null) { tareas.Add(SubirImagen(archivoTrasera, "TRASERA")); archivoTrasera = null; }
                if (archivoLicencia != null) { tareas.Add(SubirImagen(archivoLicencia, "LICENCIA")); archivoLicencia = null; }
                // if (archivoMatricula != null) { tareas.Add(SubirImagen(archivoMatricula, "MATRICULA")); archivoMatricula = null; }
                // Matrícula frontal y trasera
                if (archivoMatriculaFrontal != null)
                {
                    tareas.Add(SubirImagen(archivoMatriculaFrontal, "MATRICULA_FRONTAL"));
                    archivoMatriculaFrontal = null;
                }
                if (archivoMatriculaTrasera != null)
                {
                    tareas.Add(SubirImagen(archivoMatriculaTrasera, "MATRICULA_TRASERA"));
                    archivoMatriculaTrasera = null;
                }

                if (archivoVehiculo != null) { tareas.Add(SubirImagen(archivoVehiculo, "VEHICULO")); archivoVehiculo = null; }

                await Task.WhenAll(tareas); // espera a que todas terminen
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error al subir imágenes: {ex.Message}");
            }

            await ActualizarEstadoImagenes(fichaSeleccionada.Cedula);
            await CargarFichasAsync();

            // Mostrar mensaje de éxito solo después de guardar ficha + imágenes
            await displayMessage.DisplaySuccessMessage(esNuevo ? "Ficha creada con éxito ✅" : "Ficha actualizada correctamente ✅");

            // Limpiar todo y bloquear cédula
            fichaSeleccionada = new FichapersonalDTO();
            unidadEncontrada = null;
            duenopuestoEncontrado = null;
            codigoUnidad = string.Empty;
            cedulaDuenopuesto = string.Empty;
            esNuevo = false; // ya no es nuevo, cédula bloqueada
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
    }

    // Elimina la ficha seleccionada
    private async Task EliminarFicha()
    {
        if (!string.IsNullOrEmpty(fichaSeleccionada.Cedula))
        {
            bool confirm = await JS.InvokeAsync<bool>("confirm", "¿Estás seguro de eliminar esta ficha?");
            if (confirm)
            {
                // Eliminar ficha
                await fichaRepo.DeleteFichaPersonalById(fichaSeleccionada.Cedula);

                // Reset
                await CargarFichasAsync();
                fichaSeleccionada = new FichapersonalDTO();
                // archivoSeleccionado = null;
                esNuevo = false;
            }
        }
    }

    // Cancela edición y limpia el formulario
    private void CancelarEdicion()
    {
        fichaSeleccionada = new FichapersonalDTO();
        unidadEncontrada = null;
        duenopuestoEncontrado = null;
        esNuevo = false;
        codigoUnidad = string.Empty;
        cedulaDuenopuesto = string.Empty;
    }

    // Maneja cambio de página en paginación
    private async Task OnPageChangedAsync(int nuevaPagina)
    {
        PaginaActual = nuevaPagina;
        await CargarFichasAsync();
    }

    // Traduce código estado a texto
    private string ObtenerNombreEstado(string? estado)
    {
        return estado switch
        {
            "a" => "Activo",
            "p" => "Pasivo",
            _ => "Desconocido"
        };
    }

    // Busca unidad por código y actualiza el formulario y datos relacionados
    private async Task BuscarUnidad()
    {
        if (!string.IsNullOrWhiteSpace(codigoUnidad))
        {
            var resultado = await unidadRepo.GetUnidadById(codigoUnidad);
            if (resultado != null)
            {
                unidadEncontrada = resultado;
                fichaSeleccionada.Fkunidad = resultado.Unidad1;
            }
            else
            {
                unidadEncontrada = null;
            }
        }
    }

    //exportar 
    private async Task ExportarFicha()
    {
        if (string.IsNullOrEmpty(fichaSeleccionada?.Cedula))
        {
            await JS.InvokeVoidAsync("alert", "No hay ficha seleccionada para exportar.");
            return;
        }

        var exportData = new ExportFichaDTO
        {
            Ficha = fichaSeleccionada,
            Unidad = unidadEncontrada,
            Duenopuesto = duenopuestoEncontrado,
            Beneficiarios = beneficiarios
        };

        try
        {
            var pdfBytes = await fichaRepo.ExportarFichaCompleta(exportData);

            if (pdfBytes == null || pdfBytes.Length == 0)
            {
                await JS.InvokeVoidAsync("alert", "El PDF generado está vacío.");
                return;
            }

            await JS.InvokeVoidAsync("downloadFileFromByteArray", new
            {
                byteArray = pdfBytes,
                fileName = "FichaCompleta.pdf",
                contentType = "application/pdf"
            });
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al exportar PDF: {ex.Message}");
        }
    }

    //exportar imagenes chofer
    private async Task ExportarImagenesChofer()
    {
        if (string.IsNullOrEmpty(fichaSeleccionada?.Cedula))
        {
            await JS.InvokeVoidAsync("alert", "No hay ficha seleccionada para exportar imágenes.");
            return;
        }

        try
        {
            // Llamada al método del repositorio que descarga el PDF de imágenes
            var pdfBytes = await fichaRepo.DescargarImagenesChoferPdf(fichaSeleccionada.Cedula);

            if (pdfBytes == null || pdfBytes.Length == 0)
            {
                await JS.InvokeVoidAsync("alert", "El PDF de imágenes generado está vacío.");
                return;
            }

            // Descargar el PDF usando JavaScript
            await JS.InvokeVoidAsync("downloadFileFromByteArray", new
            {
                byteArray = pdfBytes,
                fileName = $"ImagenesChofer_{fichaSeleccionada.Cedula}.pdf",
                contentType = "application/pdf"
            });
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al exportar PDF de imágenes: {ex.Message}");
        }
    }


    //imagenes 
    
    private IBrowserFile archivoFrontal;
    private IBrowserFile archivoTrasera;
    private IBrowserFile archivoLicencia;
    // private IBrowserFile archivoMatricula;
    private IBrowserFile archivoMatriculaFrontal;
    private IBrowserFile archivoMatriculaTrasera;
    private IBrowserFile archivoVehiculo;

    private class EstadoImagen
    {
        public bool Frontal { get; set; }
        public bool Trasera { get; set; }
        public bool Licencia { get; set; }
        // public bool Matricula { get; set; }
        public bool MatriculaFrontal { get; set; }
        public bool MatriculaTrasera { get; set; }
        public bool Vehiculo { get; set; }
    }

    private EstadoImagen estadoImagen = new EstadoImagen();

    // Método que consulta al backend si existen las imágenes
    private async Task ActualizarEstadoImagenes(string cedula)
    {
        try
        {
            // Llamada a tu repo que devuelve si existen las imágenes por carpeta
            var resultado = await fichaRepo.ObtenerEstadoImagenesAsync(cedula);

            // resultado podría ser un objeto con propiedades bool Frontal, Trasera, Licencia, Matricula, Vehiculo
            estadoImagen.Frontal = resultado.Frontal;
            estadoImagen.Trasera = resultado.Trasera;
            estadoImagen.Licencia = resultado.Licencia;
            // estadoImagen.Matricula = resultado.Matricula;
            estadoImagen.MatriculaFrontal = resultado.MatriculaFrontal;  // <- separado
            estadoImagen.MatriculaTrasera = resultado.MatriculaTrasera;  // <- separado
            estadoImagen.Vehiculo = resultado.Vehiculo;

        }
        catch
        {
            // En caso de error, marcar todo como no existente
            estadoImagen = new EstadoImagen();
        }
    }

    // Selección de archivo
    private Task OnFileSelected(InputFileChangeEventArgs e, string tipoDocumento)
    {
        var file = e.File;

        switch (tipoDocumento)
        {
            case "FRONTAL": archivoFrontal = file; estadoImagen.Frontal = false; break;
            case "TRASERA": archivoTrasera = file; estadoImagen.Trasera = false; break;
            case "LICENCIA": archivoLicencia = file; estadoImagen.Licencia = false; break;
            // case "MATRICULA": archivoMatricula = file; estadoImagen.Matricula = false; break;
            case "MATRICULA_FRONTAL": archivoMatriculaFrontal = file; estadoImagen.MatriculaFrontal = false; break;
            case "MATRICULA_TRASERA": archivoMatriculaTrasera = file; estadoImagen.MatriculaTrasera = false; break;
            case "VEHICULO": archivoVehiculo = file; estadoImagen.Vehiculo = false; break;
        }

        return Task.CompletedTask;
    }

    // Subir imagen al servidor
    private async Task<IBrowserFile> ComprimirImagenAsync(IBrowserFile archivo, long maxBytes = 1_000_000)
    {
        // Calidad inicial
        int quality = 90;
        int width = 1024;
        int height = 1024;

        IBrowserFile archivoProcesado = archivo;

        // Si ya está dentro del límite, no hacemos nada
        if (archivo.Size <= maxBytes)
            return archivo;

        while (true)
        {
            // Convertimos a JPEG con las dimensiones actuales
            archivoProcesado = await archivo.RequestImageFileAsync("image/jpeg", width, height);

            // Obtenemos tamaño aproximado
            using var stream = archivoProcesado.OpenReadStream(maxBytes * 10); // abrir más grande temporal
            var buffer = new byte[stream.Length];
            await stream.ReadAsync(buffer);

            if (buffer.Length <= maxBytes || quality <= 20)
                break; // cumple el límite o llegamos a calidad mínima

            // Reducir tamaño para la siguiente iteración
            width = (int)(width * 0.9);   // reducir 10%
            height = (int)(height * 0.9);
            quality -= 10;                // reducir calidad 10%
        }

        return archivoProcesado;
    }

    private async Task SubirImagen(IBrowserFile archivo, string tipoDocumento)
    {
        if (archivo == null || string.IsNullOrEmpty(fichaSeleccionada?.Cedula))
            return;

        try
        {
            // 🔹 Comprimir progresivamente hasta 1 MB
            IBrowserFile archivoProcesado = await ComprimirImagenAsync(archivo, 1_000_000);

            using var stream = archivoProcesado.OpenReadStream(1_000_000); // límite 1 MB
            var extension = Path.GetExtension(archivo.Name);
            var nombreArchivo = archivoProcesado != archivo
                ? $"{fichaSeleccionada.Cedula}-{tipoDocumento}.jpg"
                : $"{fichaSeleccionada.Cedula}-{tipoDocumento}{extension}";

            switch (tipoDocumento)
            {
                case "FRONTAL":
                    await fichaRepo.SubirImagenChoferAsync(stream, nombreArchivo, fichaSeleccionada.Cedula, "FRONTAL");
                    break;
                case "TRASERA":
                    await fichaRepo.SubirImagenChoferAsync(stream, nombreArchivo, fichaSeleccionada.Cedula, "TRASERA");
                    break;
                case "LICENCIA":
                    await fichaRepo.SubirImagenLicenciaAsync(stream, nombreArchivo, fichaSeleccionada.Cedula);
                    break;
                // case "MATRICULA":
                //     await fichaRepo.SubirImagenMatriculaAsync(stream, nombreArchivo, fichaSeleccionada.Cedula);
                //     break;
                case "MATRICULA_FRONTAL":
                    await fichaRepo.SubirImagenMatriculaAsync(stream, nombreArchivo, fichaSeleccionada.Cedula, "frontal");
                    break;

                // Matrícula trasera
                case "MATRICULA_TRASERA":
                    await fichaRepo.SubirImagenMatriculaAsync(stream, nombreArchivo, fichaSeleccionada.Cedula, "trasera");
                    break;

                case "VEHICULO":
                    await fichaRepo.SubirImagenVehiculoAsync(stream, nombreArchivo, fichaSeleccionada.Cedula);
                    break;
                default:
                    throw new Exception("Tipo de documento no soportado");
            }

            await ActualizarEstadoImagenes(fichaSeleccionada.Cedula);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error subiendo {tipoDocumento}: {ex.Message}");
        }
    }

    // Validaciones para habilitar botones
    private bool PuedeGuardar => !string.IsNullOrWhiteSpace(fichaSeleccionada.Cedula);
    private bool PuedeEliminar => !esNuevo && !string.IsNullOrWhiteSpace(fichaSeleccionada.Cedula);
}
